# 支線 D3：分區表與分片設計

## 為什麼需要分區與分片？

當單一資料表變得過於龐大時（數百萬到數十億筆紀錄），即便有索引，查詢效能仍可能受限於
I/O 與儲存架構。這時候就需要 **分區（Partitioning）** 與
**分片（Sharding）** 來拆解壓力。

-   **分區
    (Partitioning)**：在同一個資料庫內，將單一大表依據規則拆分成多個邏輯片段。
-   **分片 (Sharding)**：將資料水平切割，分散到多個資料庫或伺服器節點。

------------------------------------------------------------------------

## 分區表設計

### 常見的分區方式

1.  **Range Partition（範圍分區）**
    -   按照數值或日期區間拆表，例如：依年份分區 `2022`, `2023`, `2024`
    -   適合日誌、交易紀錄
2.  **List Partition（列表分區）**
    -   根據明確值區分，例如：`region = 'US', 'EU', 'ASIA'`
    -   適合地區、類別等固定型資料
3.  **Hash Partition（雜湊分區）**
    -   對主鍵進行 Hash 計算，分配到不同分區
    -   適合資料分布不均的情境
4.  **Composite Partition（複合分區）**
    -   混合以上方法，例如：先依年份 Range，再依地區 List

### 分區的效益

-   提高查詢效能（僅掃描相關分區）
-   增加維護彈性（只需清理舊分區資料）
-   減少單一索引大小

------------------------------------------------------------------------

## 分片設計

### 分片的核心思路

分片是 **橫向擴展 (Horizontal Scaling)**
的代表，把資料分散到多台機器： - 每個 shard 存放部分資料 -
應用程式或中介層決定該查詢去哪個 shard

### 分片策略

1.  **水平分片（Horizontal Sharding）**
    -   依使用者 ID、訂單 ID 等切割
    -   常見公式：`shard_id = user_id % N`
2.  **垂直分片（Vertical Sharding）**
    -   按照功能拆表，例如：`user_profile` 與 `user_orders` 分不同資料庫
3.  **混合式分片**
    -   同時水平 + 垂直
    -   適合超大型系統

### 分片的挑戰

-   需要跨節點 JOIN → 成本高
-   資料重新分片時需做 **Rebalancing**
-   複雜度高（應用層需支援路由邏輯）

------------------------------------------------------------------------

## 分區 vs 分片比較

  特性       分區 (Partitioning)   分片 (Sharding)
  ---------- --------------------- -------------------------
  範圍       單一資料庫內          跨多個資料庫 / 節點
  管理       由資料庫引擎處理      需應用程式 / 中介層支援
  難度       中                    高
  使用情境   儲存大量歷史資料      全球分布、高並發系統

------------------------------------------------------------------------

## 實戰建議

1.  優先考慮 **分區**，因為維護與查詢更直觀
2.  當單一資料庫硬體極限被突破，再考慮 **分片**
3.  分片後務必搭配 **分片鍵 (Sharding Key)**
    設計，否則查詢會變成全庫掃描

------------------------------------------------------------------------

## 總結

-   **分區**：單庫內拆表 → 降低單表壓力
-   **分片**：跨庫分散 → 應對超大規模與高併發
-   設計時需權衡：維護成本 vs 系統效能

> 在下一個進階篇，我們將討論
> **資料庫快取策略**，如何與分片設計配合以提升查詢效能。
